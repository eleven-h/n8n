# 07｜进阶技巧

这章不讲高大上的概念，只讲怎么把 n8n 用顺手。你会看到：什么时候用 AI 节点、找不到节点怎么办、表达式怎么写、MCP 值不值得用、怎么一步步调试、怎么让流程更稳不崩，以及怎么省心维护。

---

## 1. 先想清楚：输入-处理-输出

做工作流就像做三明治：
- 输入：谁来触发？定时、Webhook、聊天消息、还是手动点一下？
- 处理：中间要做哪些事？条件判断、循环、数据清洗、让 AI 总结/分类？
- 输出：最后要把结果放哪？比如存表、发消息、传到网盘/数据库。

小建议：
- 流程复杂就拆开，做成“子工作流”，主流程只负责调度，清爽很多。
- 统一字段名（比如全用英文小写-中横线），以后排查不头疼。

---

## 2. AI 节点怎么选？

- Basic LLM Chain（大多数情况用它）：
  - 适合“一次性”的文本工作：摘要、改写、抽取、纠错、打标签。
  - 提示词放在“Define below”，需要结构化就打开“Require Specific Output Format”。
- AI Agent（进阶场景才用）：
  - 你需要“多轮对话、调用工具、记忆上下文”的时候，再上它。
  - 可接工具（计算器、搜索、你自己的工作流等）和记忆（Redis、Xata、Zep）。

写提示词的顺序：角色 → 要求 → 约束 → 输出格式 → 示例。先用小样本试通，再推广。

---

## 3. 找不到节点怎么办？用“半开放式”补齐

- Code 节点（JS/Python）：
  - 做轻量的数据处理：拼字段、过滤、合并、格式化。
  - 不建议在 Code 里发 HTTP、读写文件，有专用节点更稳。
- HTTP Request 节点：
  - 万能“插头”。任何没内置的 API，都可以先用 Postman 调通，再 Import cURL 进来。
  - 别把密钥写死在 Body 里，统一走 Credentials（更安全）。

常见套路：
- Google Sheets → Set → HTTP(提交任务) → Wait → HTTP(查状态) → IF(完成没) → HTTP(拿结果) → Drive/DB/消息。

---

## 4. 表达式其实很好用（别怕）

常用的就几个：
- 取数据：`$json`、`$("节点名").first().json`、`$input.all()`、`$itemIndex`
- 平台信息：`$workflow.*`、`$execution.*`、`$env`（读环境变量）
- 时间：`$now.toISO()`、`$today.toFormat('yyyy-LL-dd')`
- 查 JSON：`$jmespath('users[*].email', $json)`
- 小工具：`$if()`、`$ifEmpty()`、`$evaluateExpression()`、`$max()`、`$min()`

心法：表达式做“拿值+小修小补”，复杂逻辑交给 Code 节点。

---

## 5. MCP 要不要用？先用原生节点

- 优先用 n8n 自带或社区节点。更稳、更快、更好维护。
- 实在找不到对应服务：
  - 你要“让 AI 调你的 n8n”→ MCP Server Trigger
  - 你要“在 n8n 里调外部 MCP 工具”→ MCP Client Tool

一句话：能不用就别用，MCP 当应急工具。

---

## 6. 单步调试：每加一个节点就测一下

为啥？
- 出问题能立刻定位，不用“返工从头找”。
- 用 AI 的节点（比如提示词）本来就要反复试，边试边改很正常。

怎么测？
- 点节点上的“Test Step”只跑当前节点。
- 看 OUTPUT 面板：输入/输出/报错一目了然。
- 看不懂错误码？丢给 ChatGPT 解释一下就好。

测试用例要不要写？
- 大批量处理/数据质量不稳/用大模型：建议准备 10~20 条样本，覆盖正常/边界/异常。

---

## 7. 跑得稳：节流、分批、重试

- 有轮询就加 Wait，别 1 秒刷几十次接口（会被限流）。
- 大数据就分批（batch），比如每次 50 条；需要时并行处理几批。
- 对超时、限流这类“可重试错误”用指数退避（1s/2s/4s…）。
- 需要结构化输出的 AI，务必要求“严格 JSON 输出”，下游更省心。

---

## 8. 安全与合规：别把密钥写进节点

- 所有密钥走 Credentials 管理。
- Webhook/MCP Server 尽量在内网或加网关（鉴权+限流）。
- 日志不要打敏感信息，传给第三方前先“最小化数据”。

---

## 9. 以后维护省心的做法

- 命名规范：英文小写-中横线，时间统一时区/格式。
- 版本与回滚：重要工作流导出 JSON 存 Git；大改动前打个标签。
- 常用套路抽出来做成“子工作流/模板”，复用更快。
- 每个实战都写个简短 README：做什么、用到啥、怎么跑、容易踩的坑。

---

## 10. 常用“套路”可以直接抄

- 文本 → 结构化：LLM Chain + 要求 JSON 输出 → Parse JSON。
- 生成 → 轮询 → 下载：HTTP(POST) → Wait → HTTP(GET status) → IF → HTTP(GET result)。
- 下载 → 存储 → 发布：HTTP(download) → Drive/S3 → 三方发布（Upload-Post/社媒）。
- 表单当看板：用 Google Sheets 作为“任务面板”，输入 PROMPT/DURATION，结果回写 VIDEO/YOUTUBE_URL。
- 国内生态：没有节点就用 HTTP Request 接飞书/企微/国产大模型，必要时把现成工作流封装成“Tool”给 Agent 用。

---

## 11. Prompt 快速模板

- 标准骨架：
  - 你是…（角色）
  - 帮我…（目标）
  - 要求…（长度/风格/语言/禁用项）
  - 输出…（严格 JSON/一行文本 等）
  - 示例…（最好给一组）

- YouTube 标题（示例）：
  ```
  你是 YouTube SEO 专家。根据“视频描述”，产出 1 个 60 字内、可点击的标题。
  约束：不要过度标题党；跟输入同语言；只输出标题。
  输入："{{ $('Get new video').item.json.PROMPT }}"
  ```

- 结构化抽取（示例）：
  ```
  从文本中抽取以下字段，严格按 JSON 返回；不确定填 null：
  {
    "title": "string",
    "keywords": ["string"],
    "durationSec": "number|null"
  }
  ```

---

## 12. 想深入？看这些

- 《AI 节点详细介绍》：LLM Chain/Agent/记忆/工具 怎么配
- 《半开放式节点（Code/HTTP Request）》：没节点怎么自己接
- 《n8n 内建变量与方法（速查）》：表达式怎么写不迷路
- 《n8n 用 MCP》：真要用 MCP 时的正确打开方式
- 《单步调试与测试》：一步步测，到哪坏了看得见
- 实战：
  - 《用 Google Veo3 生成 AI 视频》完整流程
  - 《网站爬虫保存数据（1.0/2.0）》

---

一句话总结：
- 原生节点优先，不够用再上 Code/HTTP。
- AI 要模板化，提示词要迭代。
- 每加一步就测一步，慢慢来更快。
- 能复用就复用，能记笔记就写 README。

把每条工作流当“小产品”养，就会越做越稳，越做越省心。
