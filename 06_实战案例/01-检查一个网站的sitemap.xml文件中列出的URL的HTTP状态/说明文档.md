# 检查站点 sitemap.xml 中 URL 的 HTTP 状态（工作流说明）

本工作流用于：给定一个网站的 `sitemap.xml` 地址，解析其中的 URL，并批量检查这些 URL 的 HTTP 状态码；对失败或异常的 URL 进行汇总，并通过企业微信机器人（Webhook）发送告警。

文件对应工作流：`检查站点http请求状态.json`

---

## 功能概览

- 从聊天触发输入（Chat Trigger）接收一个 `sitemap.xml` 的 URL
- 拉取并解析 `sitemap.xml`，提取其中的页面 URL 列表
- 通过批处理与限速，逐个请求 URL，获取 HTTP 状态
- 统计失败的 URL，构造汇总信息
- 通过企业微信机器人 Webhook 推送告警

---

## 节点与数据流（简述）

1) When chat message received（Chat Trigger）
- 作用：作为入口触发器，接收聊天输入 `chatInput`（期望为 sitemap.xml 的地址）

2) HTTP Request1（GET sitemap.xml）
- 作用：请求上一节点输入的地址 `={{ $json.chatInput }}`

3) XML1（XML → JSON）
- 作用：将 `sitemap.xml` 的 XML 内容解析为 JSON

4) Code（提取 URL 列表）
- 逻辑：从 `urlset.url` 中提取 `loc` 字段，输出为：
  - `urls`: URL 数组
  - `total`: 数量

5) Split Out1（拆分数组）
- 作用：将 `urls` 字段拆成多条 item，便于逐条处理

6) Limit1（限制条数，示例为 3）
- 作用：演示性限流，只取前 N 条（默认 3）。实际可按需调大或移除

7) Loop Over Items1（分批循环）
- 作用：按批次执行 URL 请求（示例批量大小为 3）

8) HTTP Request（请求单个 URL）
- 作用：请求当前条目的 `={{ $json.urls }}`，开启 `fullResponse`
- 错误处理：`onError: continueRegularOutput` 以便后续统计失败项

9) If（判断响应为空/异常）
- 条件：`$json.data` 为空 → 视作失败（可按实际响应结构调整）

10) Code2（失败项建模）
- 作用：将失败请求标准化为 `{ url, statusCode, error }`

11) Merge（汇总失败项）
- 作用：将所有失败项合并

12) Code5（统计与格式化）
- 作用：根据合并的失败项构造：`totalFailed`、`failedUrls`、`summary`

13) HTTP Request9（企业微信告警）
- 作用：通过企业微信群机器人 Webhook 发送文本告警

（目录下还包含一组“平行链路”节点，以不同方式演示分页/循环与失败项整理，逻辑与上面链路类似）

---

## 输入与输出

- 输入方式：
  - 通过 Chat Trigger 的聊天输入字段 `chatInput` 传入 `sitemap.xml` 的 URL，例如：
    - `https://example.com/sitemap.xml`

- 输出与告警：
  - 在编辑器的执行数据中查看每个 URL 的状态
  - 若存在失败 URL，将通过企业微信机器人推送告警，内容包含失败数量与 URL 列表

---

## 使用步骤

1) 导入工作流
- 将 `检查站点http请求状态.json` 导入 n8n

2) 配置企业微信机器人 Webhook（可选但推荐）
- 在节点 `HTTP Request9` 中，将 `url` 替换为你自己的企业微信机器人 Webhook
- 格式示例：`https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY`

3) 调整批处理策略（可选）
- `Limit1.maxItems`：控制最大检测条数（示例为 3）
- `Loop Over Items1.batchSize`：控制每批请求的数量
- `Wait` 节点：用于在批次之间增加等待，避免触发目标站点限流

4) 运行方式
- 在 Chat 面板输入 `sitemap.xml` 地址，触发工作流
- 或改用 Webhook/定时等其他触发方式（需要自行替换入口节点）

5) 查看结果
- 在执行数据中查看每个 URL 的响应与状态
- 失败统计会被合并并通过企业微信推送（若已配置）

---

## 关键表达式与代码片段

- 读取聊天输入作为 URL：
  - `HTTP Request1.url = {{ $json.chatInput }}`

- 从 XML 解析结果中提取 URL 列表（Code 节点示例）：
```javascript
const urls = $input.first().json.urlset.url;
return {
  urls: urls.map(item => item.loc),
  total: urls.length
};
```

- 请求单个 URL：
  - `HTTP Request.url = {{ $json.urls }}`（拆分后每条是一个 URL 字符串）

- 标准化失败项（Code2 节点示例）：
```javascript
const item = $input.first();
return {
  json: {
    url: item.json.url,
    statusCode: item.json.statusCode || null,
    error: "Request failed or returned no data"
  }
};
```

- 汇总失败项并格式化（Code5 节点示例）：
```javascript
const items = $input.all;
const failedList = items.map(item => ({
  url: item.json.url,
  statusCode: item.json.statusCode
}));
return [{
  json: {
    totalFailed: failedList.length,
    failedUrls: failedList,
    summary: `Found ${failedList.length} failed URL(s)`
  }
}];
```

---

## 可配置项与建议

- 并发与限流：使用 `Loop Over Items` + `Wait` 控制频率，避免 429/封禁
- 失败判断：当前使用 `If` 判断 `$json.data` 为空；可改为根据 `statusCode`、`responseCode` 等更精确的条件
- 失败告警对象：目前示例为“企业微信机器人”，可替换为“钉钉/飞书/邮件/Slack”等通知方式
- URL 提取：若 sitemap 结构不同（如含命名空间、索引型 sitemap），需要调整 XML 解析与提取逻辑
- 最大条数：调大 `Limit1.maxItems` 或直接移除 Limit 节点进行全量检测

---

## 常见问题（FAQ）

- Q：`XML1` 解析后结构不一致，提取不到 `loc`？
  - A：不同站点的 `sitemap.xml` 结构可能不同，建议在执行数据中查看 `XML1` 输出，调整 Code 节点的读取路径

- Q：目标站点限速或报错频繁？
  - A：适当降低批量大小、在批次间增加 `Wait`、或为单个请求增加超时与重试策略

- Q：为什么有两套看起来类似的节点链路？
  - A：为演示不同拆分/循环/失败收集的写法；实际使用时可删减保留一套稳定方案

---

## 版本与备注

- 适配 n8n：v1.94.0+（建议）
- 需要启用的内置节点：Chat Trigger、HTTP Request、XML、Split/Loop、Wait、If、Merge、Code
- 本示例仅为教学/演示，生产使用前请根据实际站点结构与通知方式进行调整与压测
