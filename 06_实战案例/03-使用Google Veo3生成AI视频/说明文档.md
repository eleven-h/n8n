# 使用 Google Veo3 生成 AI 视频（工作流说明）

本说明文档基于同目录下的 `使用Google Veo3生成AI视频.json`，帮助你快速完成部署与运行。本工作流实现：
- 从 Google Sheet 读取视频生成任务（标题/时长等）
- 调用 fal.run 的 Google Veo3 接口生成视频
- 轮询任务状态，获取可下载视频地址
- 下载视频并上传至 Google Drive
- 调用 Upload-Post API 自动上传视频到 YouTube（并将链接回写至 Google Sheet）

---

## 一、前置条件与凭证

在 n8n 中配置以下凭证（Credentials）：
- fal.run API Key（Header Auth，`Authorization: Key YOURAPIKEY`）
- Google Sheets 凭证（读/写权限）
- Google Drive 凭证（上传权限）
- Upload-Post API Key（Header Auth，`Authorization: Apikey YOUR_API_KEY_HERE`）

准备以下资源：
- Google Sheet：含列 `PROMPT`、`DURATION`、`VIDEO`、`YOUTUBE_URL`、`row_number`
- Google Drive 目标文件夹：用于保存生成好的视频文件

> 备注：示例 JSON 中的 Sheet/Folder ID 为演示用途，请替换为你的实际 ID。

---

## 二、整体流程（节点图解）

触发方式（两种任选其一）：
- `When clicking 'Test workflow'` 手动触发
- `Schedule Trigger` 定时触发（建议 5 分钟一次）

主流程：
1. `Get new video`（Google Sheets）
   - 读取 Google Sheet 中待处理的行（`VIDEO` 为空），获取 `PROMPT` 与 `DURATION` 等
2. `Set data`（Set）
   - 组装 Veo3 的 `prompt` 输入（将 `PROMPT` 与 `DURATION` 拼入）
3. `Create Video`（HTTP Request → fal.run veo3）
   - 发送生成请求，返回 `request_id`
4. `Wait 60 sec.`（Wait）
   - 等待 60 秒后进行状态轮询
5. `Get status`（HTTP Request）
   - 根据 `$('Create Video').item.json.request_id` 查询任务状态
6. `Completed?`（If）
   - 判断状态是否为 `COMPLETED`
   - 是：进入获取结果分支
   - 否：回到 `Wait 60 sec.` 继续轮询
7. `Get Url Video`（HTTP Request）
   - 获取生成结果详情（包含 `video.url`、`video.file_name`）
8. `Generate title`（OpenAI / LangChain 节点）
   - 基于 `PROMPT` 生成 YouTube SEO 友好标题（模型示例 `gpt-4o-mini`）
9. `Get File Video`（HTTP Request）
   - 根据 `video.url` 下载视频（二进制）
10. `Upload Video`（Google Drive）
    - 将视频上传至指定 Drive 文件夹（自动命名 `时间戳-文件名`）
11. `HTTP Request`（Upload-Post API）
    - 以 `multipart/form-data` 方式将视频上传到 YouTube（通过 Upload-Post 平台）
12. `Update result`（Google Sheets）
    - 回写 `VIDEO`（生成视频链接）与 `row_number`
13. `Update Youtube URL`（Google Sheets）
    - 回写 `YOUTUBE_URL`（`https://youtu.be/{video_id}`）

---

## 三、关键节点与参数说明

- `Get new video`（Google Sheets：Read）
  - 按 `VIDEO` 为空进行筛选（待处理任务）
  - 输出字段需至少包含：`PROMPT`、`DURATION`、`row_number`

- `Set data`（Set）
  - 构造 `prompt` 字段，例如：
    ```
    prompt = `${PROMPT}\n\nDuration of the video: ${DURATION}`
    ```

- `Create Video`（HTTP Request → fal.run）
  - 方法：POST
  - URL：`https://queue.fal.run/fal-ai/veo3`
  - Header：`Content-Type: application/json`，以及授权头
  - Body (JSON)：`{ "prompt": "{{$json.prompt}}" }`
  - 输出：`request_id`

- `Wait 60 sec.`（Wait）
  - 避免高频轮询；根据你的生成时长调整等待间隔

- `Get status`（HTTP Request）
  - URL：`https://queue.fal.run/fal-ai/veo3/requests/{{ $('Create Video').item.json.request_id }}/status`
  - 输出含 `status` 字段（例如 `COMPLETED`）

- `Completed?`（If）
  - 条件：`$json.status === 'COMPLETED'`

- `Get Url Video`（HTTP Request）
  - URL：`https://queue.fal.run/fal-ai/veo3/requests/{{ $json.request_id }}`
  - 输出：`video.url`、`video.file_name`

- `Generate title`（OpenAI/LangChain）
  - System 提示词中包含 SEO 规则与语言要求
  - 输入：`$('Get new video').item.json.PROMPT`
  - 输出：`message.content`（标题文本）

- `Get File Video`（HTTP Request）
  - URL：`{{ $('Get Url Video').item.json.video.url }}`
  - 输出：二进制 `data`

- `Upload Video`（Google Drive）
  - 目标文件夹：请替换为你的文件夹 ID
  - 文件名：`{{$now.format('yyyyLLddHHmmss')}}-{{ $('Get Url Video').item.json.video.file_name }}`

- `HTTP Request`（Upload-Post）
  - 方法：POST
  - URL：`https://api.upload-post.com/api/upload`
  - Header：`Authorization: Apikey YOUR_API_KEY_HERE`
  - Body：`multipart/form-data`
    - `title`：`{{ $('Generate title').item.json.message.content }}`
    - `user`：`YOUR_USERNAME`（Upload-Post 平台的 Profile 名）
    - `platform[]`：`youtube`
    - `video`：二进制（`inputDataFieldName = data`）
  - 返回：包含 `results.youtube.video_id` 等

- `Update result` / `Update Youtube URL`（Google Sheets：Update）
  - 根据 `row_number` 精确回写：`VIDEO`（生成视频链接）与 `YOUTUBE_URL`

---

## 四、部署与运行步骤

1. 导入工作流 JSON 到 n8n
2. 在 Credentials 中配置：fal.run、Google Sheets、Google Drive、Upload-Post 的凭证
3. 替换以下占位/示例 ID：
   - Google Sheet `documentId` / `sheetName`
   - Google Drive `folderId`
4. 确认 Google Sheet 列结构与节点映射一致
5. 视需求选择触发方式：
   - 手动：点击 `Test workflow`
   - 定时：启用 `Schedule Trigger` 并设置间隔
6. 运行并在执行数据中检查每一步输出是否符合预期

---

## 五、常见问题与排错

- 状态一直未完成
  - 增加等待时间；检查 fal.run 额度与服务状态
- 无法获取 `video.url`
  - 确认 `request_id` 传递正确；查看 `Get Url Video` 的响应结构
- Google Sheets 无法回写
  - 确认凭证权限；检查 `row_number` 是否存在且作为匹配列
- 上传 YouTube 失败
  - 检查 Upload-Post 的 API Key、Profile 名（`YOUR_USERNAME`）与配额
- 标题为空或不理想
  - 调整 `Generate title` 的提示词策略或模型

---

## 六、最佳实践

- 使用 `Wait` + 轮询的方式控制频率，避免触发对方 API 限流
- 在分支中增加错误捕获与兜底（如空值检查、失败重试）
- 将 Google Sheet 作为“控制台”：输入 PROMPT 与 DURATION，自动生成并回写结果
- 标题生成可根据频道风格微调提示词，或替换为本地/其他模型

---

如需进一步拓展：可在上传前插入视频后处理（加片头片尾、转码）、在发布后联动社媒通知等，均可在此工作流基础上按需扩展。
