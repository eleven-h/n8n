# 📤 n8n 内建变量与方法（表达式速查）

n8n 虽是类低代码平台，但在节点间“取数、改数、拼数”的场景下，经常需要在表达式或 Code 节点里写少量代码。本文整理 n8n 常用的内建变量与方法，配以可直接复制的示例，帮你高效完成数据处理，该实例通过将n8n官方文档喂给gemini进行的输出，可能部分示例不够完整准确，欢迎补充修改。

> 提示：本文示例默认用于“表达式模式”。请将输入框切换为 Expression，并用 `{{ ... }}` 包裹表达式。

---

## 0. 快速上手：表达式基础

- 切换到 Expression 后，使用 `{{ 表达式 }}`
- 可直接访问上游项 `json`/`binary` 数据
- 支持 Javascript 表达式与 n8n 扩展变量/方法混用

示例：
```text
{{ $json.title || $json.name || "未命名" }}
```

---

## 1. 内建变量（Built-ins）

### 1.1 当前节点输入（Current node input）
- `$input.item`：当前正在处理的输入项（包含 `json` 与可选 `binary`）
- `$input.all()`：返回所有输入项数组
- `$input.first()` / `$input.last()`：第一项 / 最后一项
- `$input.params`：上游节点的设置快照（如结果限制、操作类型）
- `$json`：`$input.item.json` 的简写
- `$binary`：`$input.item.binary` 的简写
- `$input.context.noItemsLeft`：仅在“Loop Over Items”场景下，是否无剩余项

示例：
```text
{{ $json.name }}
{{ $input.all().map(i => i.json.id) }}
{{ $input.first().json.title }}
```

### 1.2 访问其他节点的输出（Output of other nodes）
使用 `$("<node-name>")` 访问指定节点：
- `$("节点名").all(branchIndex?, runIndex?)`
- `$("节点名").first(branchIndex?, runIndex?)`
- `$("节点名").last(branchIndex?, runIndex?)`
- `$("节点名").item`：与当前项相连的那一条输出
- `$("节点名").params`：该节点的配置参数快照
- `$("节点名").itemMatching(currentNodeInputIndex)`：在 Code 节点追溯输入来源

示例：
```text
{{ $("HTTP Request").first().json.title }}
{{ $("Create User").item.json.id }}
```

### 1.3 平台与执行元数据（n8n metadata）
- `$env`：读取环境变量（如 `.env`）
- `$execution.*`：本次执行上下文（`id`、`mode`、`resumeUrl`、`customData`）
- `$getWorkflowStaticData(type)`：读写工作流级静态数据（`global`/`node`）
- `$("节点名").isExecuted`：该节点是否已执行
- `$itemIndex`：当前项的索引（从 0 开始）
- `$nodeVersion`：当前节点版本
- `$prevNode.*`：上一个节点信息（`name`/`outputIndex`/`runIndex`）
- `$runIndex`：当前节点运行轮次
- `$secrets`：密钥集合
- `$vars`：可用的变量集合
- `$version`：n8n 版本
- `$workflow.*`：工作流信息（`id`/`name`/`active`）

示例：
```text
{{ $env["API_KEY"] }}
{{ $workflow.id }}
{{ $execution.mode }}
```

### 1.4 日期与时间（Luxon）
- `$now`：当前时间（Luxon DateTime）
- `$today`：今日（去时分秒的 DateTime）

示例（注意 Luxon 格式化）：
```text
{{ $now.toISO() }}
{{ $today.toFormat('yyyy-LL-dd') }}
```

### 1.5 HTTP 节点分页变量（仅 HTTP 节点）
- `$http.pagination.page` / `perPage` / `total` / `totalPages`

示例：
```text
{{ $http.pagination.page }}
```

### 1.6 LangChain 代码节点变量（仅 LangChain Code）
- `$llmInput`：模型输入
- `$generateText()`：生成文本的方法
- `$memory`：记忆对象

示例：
```text
{{ $generateText($llmInput) }}
```

---

## 2. 常用内建方法（Helpers）

### 2.1 JMESPath 查询：`$jmespath(expression, data)`
对复杂 JSON 进行搜索/筛选/投影。

示例数据：
```json
{
  "users": [
    { "id": 1, "name": "John", "email": "john@example.com" },
    { "id": 2, "name": "Jane", "email": "jane@example.com" }
  ]
}
```

示例：
```text
{{ $jmespath('users[*].email', $json) }}            // => ["john@example.com","jane@example.com"]
{{ $jmespath('users[?id > `1`]', $json) }}          // => 过滤出 id>1 的用户
```

### 2.2 便捷方法
- `$evaluateExpression(expression, itemIndex?)`：把字符串当表达式求值
- `$ifEmpty(value, defaultValue)`：空值兜底
- `$if(condition, valueIfTrue, valueIfFalse)`：条件分支
- `$max(...numbers)` / `$min(...numbers)`：求最大/最小

示例：
```text
{{ $evaluateExpression('1 + 2') }}                  // 3
{{ $ifEmpty($json.description, 'No description') }}
{{ $if($json.status === 'success', 'OK', 'Error') }}
{{ $max(3, 5, 1) }}  {{ $min(3, 5, 1) }}
```

---

## 3. 数据转换与常见 JS 操作（在表达式中使用）

n8n 表达式支持标准 JavaScript 能力，建议优先使用原生方法，避免各版本差异。

- 字符串：
```text
{{ ($json.title || '').toLowerCase() }}
{{ ($json.text || '').includes('关键字') }}
{{ ($json.slug || '').trim().replace(/\s+/g,'-') }}
```

- 数字：
```text
{{ Number($json.count || 0) }}
{{ (Number($json.price)||0).toFixed(2) }}
```

- 数组：
```text
{{ ($json.items || []).map(i => i.id) }}
{{ ($json.items || [])[0] }}                 // 第一项
{{ ($json.items || []).filter(i => i.ok) }}
{{ Array.from(new Set(($json.tags||[]))) }}  // 唯一化
```

- 对象：
```text
{{ Object.keys($json) }}
{{ JSON.stringify($json.payload || {}) }}
```

- 日期（Luxon）：
```text
{{ $now.plus({ days: 7 }).toISO() }}
{{ $now.setZone('Asia/Shanghai').toFormat('yyyy-LL-dd HH:mm') }}
```

---

## 4. 使用场景示例

1) 获取当前节点输入里的邮箱：
```text
{{ $json.email }}
```

2) 获取名为 Webhook 的首条消息：
```text
{{ $("Webhook").first().json.message }}
```

3) 获取当前工作流名称与执行 ID：
```text
{{ $workflow.name }} - {{ $execution.id }}
```

4) 生成“今天”与“7 天后”的日期：
```text
{{ $today.toFormat('yyyy-LL-dd') }} / {{ $now.plus({days:7}).toFormat('yyyy-LL-dd') }}
```

5) JMESPath 提取与筛选：
```text
{{ $jmespath('data.items[?active==`true`].name', $json) }}
```

---

## 5. 速查表（Cheatsheet）

常用变量：
- 当前输入：`$json`、`$binary`、`$input.item`、`$input.all()`、`$input.first()`、`$input.last()`
- 节点取数：`$("节点名").first().json`、`$("节点名").item.json`
- 平台信息：`$env`、`$workflow.*`、`$execution.*`、`$runIndex`、`$itemIndex`
- 时间：`$now`、`$today`（配合 `toISO()` / `toFormat()`）

常用方法：
- JMESPath：`$jmespath(expr, data)`
- 条件与兜底：`$if()`、`$ifEmpty()`
- 计算：`$evaluateExpression()`、`$max()`、`$min()`

---

## 6. 常见坑位与建议

- 表达式与纯文本混用时，注意用 `{{ }}` 包裹表达式；字符串内的花括号请转义
- Luxon 的格式化使用 `toFormat('yyyy-LL-dd')` 等新式 tokens，避免 `YYYY-MM-DD`
- 取其他节点输出时，确保节点名完全匹配；多分支/多次运行时可用 `first(runIndex)` 精确定位
- 大算子请在 Code 节点完成；表达式中保持“取值与轻度整形”为主

---

> 参考官方文档可获取最准确的行为说明。如遇表达式报错，先在“执行数据”面板检查上游结构与字段名是否存在，再逐步缩小表达式范围定位问题。
